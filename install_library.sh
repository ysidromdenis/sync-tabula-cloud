#!/bin/bash

# Script de instalaciÃ³n mejorado para Tabula Cloud Sync LibrerÃ­a
# VersiÃ³n 2.0 - Ahora como librerÃ­a reutilizable

set -e

echo "ðŸš€ Instalando Tabula Cloud Sync LibrerÃ­a..."

# Detectar Python
if command -v python3 &> /dev/null; then
    PYTHON=python3
elif command -v python &> /dev/null; then
    PYTHON=python
else
    echo "âŒ Error: Python no encontrado. Instala Python 3.7+ primero."
    exit 1
fi

# Verificar versiÃ³n de Python
PYTHON_VERSION=$($PYTHON -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
echo "ðŸ“ Python detectado: $PYTHON_VERSION"

# Verificar que la versiÃ³n sea 3.7 o superior
if $PYTHON -c "import sys; exit(0 if sys.version_info >= (3, 7) else 1)" 2>/dev/null; then
    echo "âœ… VersiÃ³n de Python vÃ¡lida"
else
    echo "âŒ Error: Se requiere Python 3.7 o superior. VersiÃ³n actual: $PYTHON_VERSION"
    exit 1
fi

# Verificar pip
if ! command -v pip &> /dev/null && ! command -v pip3 &> /dev/null; then
    echo "âŒ Error: pip no encontrado. Instala pip primero."
    exit 1
fi

PIP=$(command -v pip3 || command -v pip)

# Opciones de instalaciÃ³n
INSTALL_MODE="basic"
INSTALL_DEV=false
INSTALL_DATABASE=false
PROJECT_DIR=""

# Procesar argumentos
while [[ $# -gt 0 ]]; do
    case $1 in
        --dev)
            INSTALL_DEV=true
            shift
            ;;
        --database)
            INSTALL_DATABASE=true
            shift
            ;;
        --project-dir)
            PROJECT_DIR="$2"
            shift 2
            ;;
        --help)
            echo "Uso: $0 [opciones]"
            echo ""
            echo "Opciones:"
            echo "  --dev          Instalar dependencias de desarrollo"
            echo "  --database     Instalar soporte para bases de datos"
            echo "  --project-dir  Directorio donde inicializar el proyecto"
            echo "  --help         Mostrar esta ayuda"
            exit 0
            ;;------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
            +.

            ----------------------------------------------------------------------------------------------------+
            
        *)
            echo "âŒ OpciÃ³n desconocida: $1"
            echo "Usa --help para ver opciones disponibles"
            exit 1
            ;;
    esac
done

# Determinar comando de instalaciÃ³n
INSTALL_CMD="$PIP install tabula-cloud-sync"

if [[ "$INSTALL_DEV" == true ]]; then
    INSTALL_CMD="$INSTALL_CMD[dev]"
    echo "ðŸ“¦ Modo: Desarrollo (incluye dependencias de dev)"
elif [[ "$INSTALL_DATABASE" == true ]]; then
    INSTALL_CMD="$INSTALL_CMD[database]"
    echo "ðŸ“¦ Modo: Con soporte para bases de datos"
else
    echo "ðŸ“¦ Modo: InstalaciÃ³n bÃ¡sica"
fi

# Instalar librerÃ­a
echo "â¬‡ï¸  Instalando librerÃ­a..."
if [[ -f "setup.py" ]]; then
    # InstalaciÃ³n local (desarrollo)
    echo "ðŸ“ Detectado setup.py local - Instalando en modo desarrollo..."
    $PIP install -e .
    
    if [[ "$INSTALL_DEV" == true ]]; then
        $PIP install -e .[dev]
    fi
    
    if [[ "$INSTALL_DATABASE" == true ]]; then
        $PIP install -e .[database]
    fi
else
    # InstalaciÃ³n desde PyPI
    eval "$INSTALL_CMD"
fi

echo "âœ… LibrerÃ­a instalada exitosamente"

# Verificar instalaciÃ³n
echo "ðŸ” Verificando instalaciÃ³n..."
if $PYTHON -c "import tabula_cloud_sync; print(f'Tabula Cloud Sync v{tabula_cloud_sync.__version__} instalado correctamente')" 2>/dev/null; then
    echo "âœ… VerificaciÃ³n exitosa"
else
    echo "âŒ Error en la verificaciÃ³n de instalaciÃ³n"
    exit 1
fi

# Inicializar proyecto si se especificÃ³ directorio
if [[ -n "$PROJECT_DIR" ]]; then
    echo "ðŸ—ï¸  Inicializando proyecto en: $PROJECT_DIR"
    
    if [[ ! -d "$PROJECT_DIR" ]]; then
        mkdir -p "$PROJECT_DIR"
    fi
    
    cd "$PROJECT_DIR"
    
    # Usar CLI para inicializar
    if command -v tabula-cli &> /dev/null; then
        echo "ðŸ“‹ Ejecutando configuraciÃ³n inicial..."
        tabula-cli init --project-name "$(basename "$PROJECT_DIR")"
        echo "âœ… Proyecto inicializado en $PROJECT_DIR"
    else
        echo "âš ï¸  CLI no disponible, creando estructura bÃ¡sica..."
        
        # Crear estructura bÃ¡sica manualmente
        mkdir -p config logs data cache services models
        
        # Crear archivo de configuraciÃ³n bÃ¡sico
        cat > config/tabula_config.ini << 'EOF'
[API]
base_url = https://api.tabula.com.py
version = v1
api_key = YOUR_API_KEY_HERE
timeout = 30

[SYNC]
interval = 300
batch_size = 100
retry_attempts = 3
auto_start = true

[LOGGING]
level = INFO
file = logs/tabula_service.log
max_size = 10MB
backup_count = 5
EOF
        
        echo "ðŸ“ Estructura bÃ¡sica creada"
        echo "âš™ï¸  Edita config/tabula_config.ini con tus credenciales"
    fi
fi

# InformaciÃ³n final
echo ""
echo "ðŸŽ‰ InstalaciÃ³n completada exitosamente!"
echo ""
echo "ðŸ“ PrÃ³ximos pasos:"
echo "   1. Importa la librerÃ­a: from tabula_cloud_sync import TabulaCloudService"
echo "   2. Crea tu servicio personalizado heredando de TabulaCloudService"
echo "   3. Implementa el mÃ©todo perform_sync() con tu lÃ³gica"
echo ""
echo "ðŸ› ï¸  Comandos disponibles:"
echo "   tabula-cli init          - Inicializar nuevo proyecto"
echo "   tabula-cli status        - Ver estado del proyecto actual"
echo "   tabula-service start     - Iniciar servicio como daemon"
echo ""
echo "ðŸ“– DocumentaciÃ³n: https://github.com/ysidromdenis/template-sync-tabula-cloud"
echo "ðŸ’¬ Soporte: contacto@tabula.com.py"

# Detectar shell para sugerir actualizaciÃ³n de PATH
if [[ -n "$SHELL" ]]; then
    echo ""
    echo "ðŸ’¡ Tip: Si los comandos CLI no funcionan, ejecuta:"
    echo "   source ~/.bashrc  # o ~/.zshrc segÃºn tu shell"
fi
